name: Deploy tg-proxy to SAP BTP

on:
  workflow_dispatch:

env:
  BTP_APP_NAME: my-tg-proxy-docker   # BTP 上的应用名称
  DOCKER_IMAGE: songnidedubai/tg-proxy # Docker 镜像

jobs:
  deploy-to-btp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install CF CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y wget ca-certificates
          wget -qO- "https://packages.cloudfoundry.org/stable?release=debian64&source=github" | tar -zx
          sudo mv cf /usr/local/bin/cf
          cf --version

      - name: Login to BTP
        run: |
          cf api "${{ secrets.BTP_API }}" --skip-ssl-validation || cf api "${{ secrets.BTP_API }}"
          cf auth "${{ secrets.BTP_USER }}" "${{ secrets.BTP_PASS }}"
          cf target -o "${{ secrets.BTP_ORG }}" -s "${{ secrets.BTP_SPACE }}"

      - name: Push Docker Image to BTP
        run: |
          cf push ${{ env.BTP_APP_NAME }} \
            --docker-image ${{ env.DOCKER_IMAGE }} \
            --docker-username "dummy" \
            --random-route \
            -m 128M \
            --no-start

      - name: Set Environment Variables
        run: |
          cf set-env ${{ env.BTP_APP_NAME }} BOT_TOKEN "${{ secrets.TG_BOT_TOKEN }}"
          cf set-env ${{ env.BTP_APP_NAME }} CHAT_ID "${{ secrets.TG_CHAT_ID }}"
          cf set-env ${{ env.BTP_APP_NAME }} PROXY_SECRET "${{ secrets.TG_PROXY_SECRET }}"

      - name: Start Application
        run: cf start ${{ env.BTP_APP_NAME }}
